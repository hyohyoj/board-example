<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="hyo.boardexample.mapper.BoardMapper">

    <sql id="search">
        <choose>
            <when test="keyword == 'user_id'.toString()">
                AND user_id LIKE CONCAT('%',#{searchContent},'%')
                AND target IS NULL
            </when>
            <when test="keyword == 'board_title'.toString()">
                AND board_title LIKE CONCAT('%',#{searchContent},'%')
                AND target IS NULL
            </when>
            <otherwise>
                AND board_content LIKE CONCAT('%',#{searchContent},'%')
                AND target IS NULL
            </otherwise>
        </choose>

    </sql>

    <select id="boardCount" parameterType="hyo.boardexample.domain.Board" resultType="int">
        SELECT count(board_no) AS cnt FROM board
        WHERE delete_yn = 'N'
        <if test="searchContent != null">
            <include refid="search"></include>
        </if>
        <if test="type_no != null">
            AND type_no = #{type_no}
        </if>
    </select>

    <select id="getList" parameterType="hyo.boardexample.domain.Board" resultType="hyo.boardexample.domain.Board">
        SELECT
             board_no
            ,user_id
            ,board_title
            ,board_content
            ,insert_date
            ,target
            ,type_no
            ,notice_yn
        FROM board
        WHERE delete_yn = 'N'
        <if test="searchContent != null">
            <include refid="search"></include>
        </if>
        <if test="type_no != null">
            AND type_no = #{type_no}
        </if>
        <choose>
            <when test="page != null">
                LIMIT #{page}, 10
            </when>
            <otherwise>
                LIMIT 0, 10
            </otherwise>
        </choose>
    </select>

    <!-- 공지사항 목록 상단 출력 (최근 3개 까지) -->
    <select id="getNoticeList" parameterType="hyo.boardexample.domain.Board" resultType="hyo.boardexample.domain.Board">
        SELECT
             board_no
            ,user_id
            ,board_title
            ,insert_date
            ,target
            ,type_no
        FROM
            board
        WHERE
            delete_yn = 'N'
        AND
            notice_yn = 'Y'
        <if test="type_no != null">
            AND type_no = #{type_no}
        </if>
        ORDER BY insert_date DESC
        LIMIT 3
    </select>

    <select id="getAnswerList" parameterType="Integer" resultType="hyo.boardexample.domain.Board">
        SELECT
             user_id
            ,board_content
            ,insert_date
        FROM board
        WHERE target = #{num}
    </select>

    <select id="getOne" parameterType="Integer" resultType="hyo.boardexample.domain.Board">
        SELECT
             board_no
            ,user_id
            ,board_title
            ,board_content
            ,insert_date
            ,type_no
            ,notice_yn
        FROM board
        WHERE board_no = #{num}
    </select>

    <select id="getKind" parameterType="Integer" resultType="String">
        SELECT
            t.kind
        FROM
            board b, board_type t
        WHERE
            b.type_no = t.type_no
        AND b.board_no = #{num}
    </select>

    <update id="update" parameterType="hyo.boardexample.domain.Board">
        UPDATE
            board
        SET
             board_content = #{board_content}
            ,type_no = #{type_no}
            <choose>
                <when test="notice_yn == 'Y'.toString()">
                    ,notice_yn = #{notice_yn}
                </when>
                <otherwise>
                    ,notice_yn = 'N'
                </otherwise>
            </choose>
        WHERE
            board_no = #{board_no}
    </update>

    <update id="modifyBoardYn" parameterType="hyo.boardexample.domain.Board">
        UPDATE
            board
        SET
            delete_yn = #{delete_yn}
        WHERE
            type_no = #{type_no}
    </update>

    <insert id="insert" parameterType="hyo.boardexample.domain.Board" useGeneratedKeys="true" keyProperty="board_no">
        <choose>
            <when test="target != null">
                INSERT INTO board(
                     board_content
                    ,user_id
                    ,target
                )
                VALUES(
                     #{board_content}
                    ,#{user_id}
                    ,#{target}
                )
            </when>
            <otherwise>
                INSERT INTO board(
                     board_title
                    ,board_content
                    ,user_id
                    ,type_no
                    ,notice_yn
                )
                VALUES(
                     #{board_title}
                    ,#{board_content}
                    ,#{user_id}
                    ,#{type_no}
                    <choose>
                        <when test="notice_yn == 'Y'.toString()">
                            ,#{notice_yn}
                        </when>
                        <otherwise>
                            ,'N'
                        </otherwise>
                    </choose>
                )
            </otherwise>
        </choose>
    </insert>

    <delete id="delete" parameterType="hyo.boardexample.domain.Board">
        DELETE FROM board
        WHERE board_no = #{board_no}
    </delete>

    <delete id="deleteAnswer" parameterType="hyo.boardexample.domain.Board">
        DELETE FROM board
        WHERE target =  #{board_no}
    </delete>

</mapper>